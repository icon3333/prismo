<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Prismo{% endblock %}</title>

    <!-- Prevent white flash on page load -->
    <style>
        html, body {
            background-color: #F8FAFC;
            margin: 0;
            padding: 0;
        }
        [data-theme="dark"] html,
        [data-theme="dark"] body,
        html[data-theme="dark"],
        html[data-theme="dark"] body {
            background-color: #020617;
        }
    </style>

    <!-- Set theme before any content renders -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') ||
                         (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            document.documentElement.style.backgroundColor = theme === 'dark' ? '#020617' : '#F8FAFC';
        })();
    </script>

    <!-- Set anonymous mode before any content renders -->
    <script>
        (function() {
            if (sessionStorage.getItem('anonymousModeEnabled') === 'true') {
                document.documentElement.classList.add('anonymous-mode');
            }
        })();
    </script>

    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fontawesome/css/all.min.css') }}">

    <!-- Ocean Depth Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ocean-depth.css') }}">

    <!-- Anonymous Mode -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/anonymous-mode.css') }}">

    <!-- Floating Controls -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/floating-controls.css') }}">

    <!-- Tabulator (data tables) -->
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_midnight.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tabulator-ocean.css') }}">

    <!-- Page-specific CSS -->
    {% block head_extras %}{% endblock %}

    <style>
        /* Sidebar Layout System */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar-container {
            width: 240px;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-subtle);
            z-index: 50;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
        }

        .app-footer {
            padding: 1.5rem 0;
            border-top: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            font-size: 0.875rem;
            text-align: center;
        }

        /* Full width mode (no sidebar) */
        .main-container.full-width {
            width: 100%;
        }

        /* Responsive sidebar */
        @media (max-width: 768px) {
            .sidebar-container {
                display: none;
            }
            .main-container {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="app-wrapper">
        <!-- Sidebar - Show by default unless show_sidebar is explicitly set to false -->
        {% if show_sidebar is not defined or show_sidebar %}
        <div class="sidebar-container">
            {% include 'components/sidebar.html' %}
        </div>
        {% endif %}

        <!-- Main Content -->
        <div class="main-container {% if show_sidebar is defined and not show_sidebar %}full-width{% endif %}">
            <!-- Navigation -->
            {% include 'components/navbar.html' %}

            <!-- Content -->
            <div class="content-wrapper">
                <main class="container">
                    <!-- Flash Messages -->
                    {% include 'components/messages.html' %}

                    <!-- Page Content -->
                    {% block content %}{% endblock %}
                </main>
            </div>

            <!-- Footer -->
            {% include 'components/footer.html' %}
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- External Libraries -->
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.44.0/dist/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Theme Toggle JS -->
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

    <!-- Global Portfolio State -->
    <script src="{{ url_for('static', filename='js/portfolio-state.js') }}"></script>

    <!-- Anonymous Mode JS -->
    <script src="{{ url_for('static', filename='js/anonymous-mode.js') }}"></script>

    <!-- Chart Configuration -->
    <script src="{{ url_for('static', filename='js/apex_chart_config.js') }}"></script>

    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    {% block scripts %}{% endblock %}

    <!-- Floating Controls Component -->
    {% include 'components/floating_controls.html' %}
</body>
</html>
